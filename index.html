<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikacja dla Seniorów</title>
    <!-- Ładowanie Tailwind CSS dla prostego i czytelnego stylu -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import czcionki Inter dla lepszej czytelności */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #333;
        }
        .container {
            max-width: 100%;
            padding: 1rem;
        }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .header {
            text-align: center;
        }
        .time-date {
            font-size: 2rem;
            font-weight: 600;
            color: #4a5568;
        }
        .menu-button {
            padding: 1.5rem;
            border-radius: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            transition: transform 0.2s;
            cursor: pointer;
            width: 100%;
        }
        .menu-button:hover {
            transform: scale(1.02);
        }
        .game-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .game-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        .game-title {
            font-size: 1rem;
            font-weight: 600;
        }
        .message-box {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 1rem 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .message-box.show {
            opacity: 1;
        }
        .reminder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background-color: #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .delete-btn {
            background-color: #ef4444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .delete-btn:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- Kontener główny aplikacji -->
    <div id="app-container" class="container bg-white p-6 rounded-3xl shadow-xl w-full max-w-lg transition-all duration-500 ease-in-out">
        
        <!-- Ekran główny -->
        <div id="main-screen">
            <div class="header mb-6">
                <div id="time-display" class="text-5xl font-extrabold text-blue-700"></div>
                <div id="date-display" class="text-xl font-semibold text-gray-500"></div>
                <div id="user-info" class="text-lg font-semibold text-gray-700 mt-2"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <button onclick="showReminders()" class="menu-button bg-blue-500 text-white hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    Przypomnienia 🔔
                </button>
                <button onclick="showGames()" class="menu-button bg-green-500 text-white hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300">
                    Gry 🎮
                </button>
            </div>
            <div class="grid grid-cols-1 gap-4 mb-6">
                <button onclick="showRanking()" class="menu-button bg-yellow-500 text-white hover:bg-yellow-600 focus:outline-none focus:ring-4 focus:ring-yellow-300">
                    Ranking 🏆
                </button>
            </div>


            <!-- Przyciski logowania, widoczne tylko dla niezalogowanych użytkowników -->
            <div id="auth-buttons" class="grid grid-cols-2 gap-4">
                <button onclick="signInWithGoogle()" class="menu-button bg-red-500 text-white hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300 flex items-center justify-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/2048px-Google_%22G%22_logo.svg.png" class="w-6 h-6 mr-2" alt="Google Logo">
                    Zaloguj z Google
                </button>
                <button onclick="signInWithFacebook()" class="menu-button bg-blue-700 text-white hover:bg-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-500 flex items-center justify-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b5/Facebook_Logo_%282019%29.svg/1024px-Facebook_%22G%22_logo.svg.png" class="w-6 h-6 mr-2" alt="Facebook Logo">
                    Zaloguj z Facebook
                </button>
            </div>
            
            <!-- Przycisk wylogowania, widoczny tylko dla zalogowanych użytkowników -->
            <button id="logout-button" onclick="signOutUser()" class="hidden menu-button bg-gray-500 text-white hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-300">
                Wyloguj
            </button>
        </div>

        <!-- Ekran przypomnień -->
        <div id="reminders-screen" class="hidden">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">Moje Przypomnienia</h2>
            <div class="flex flex-col gap-4">
                <div class="flex items-center">
                    <input type="text" id="new-reminder-input" class="flex-grow p-3 rounded-l-lg border-2 border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Dodaj nowe przypomnienie...">
                    <button onclick="addReminder()" class="bg-blue-500 text-white p-3 rounded-r-lg hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        Dodaj
                    </button>
                </div>
                <div id="reminders-list" class="flex flex-col gap-2">
                    <!-- Przypomnienia będą dodawane tutaj dynamicznie -->
                </div>
                <button onclick="showMainScreen()" class="menu-button bg-gray-500 text-white hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-300">
                    Powrót
                </button>
            </div>
        </div>

        <!-- Ekran gier -->
        <div id="games-screen" class="hidden">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">Wybierz Grę</h2>
            <div class="grid grid-cols-2 gap-4">
                <button class="game-card card bg-blue-200 text-blue-800 hover:bg-blue-300">
                    <span class="game-icon">🧠</span>
                    <span class="game-title">Trening Pamięci</span>
                </button>
                <button class="game-card card bg-green-200 text-green-800 hover:bg-green-300">
                    <span class="game-icon">🔢</span>
                    <span class="game-title">Szybkie Liczenie</span>
                </button>
                <button class="game-card card bg-yellow-200 text-yellow-800 hover:bg-yellow-300">
                    <span class="game-icon">🧩</span>
                    <span class="game-title">Puzzle</span>
                </button>
                <button class="game-card card bg-purple-200 text-purple-800 hover:bg-purple-300">
                    <span class="game-icon">🔤</span>
                    <span class="game-title">Słowa</span>
                </button>
            </div>
            <button onclick="showMainScreen()" class="menu-button bg-gray-500 text-white hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-300 mt-6">
                Powrót
            </button>
        </div>

        <!-- Ekran rankingu -->
        <div id="ranking-screen" class="hidden">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">Ranking Graczy</h2>
            <p class="text-center text-gray-600 mb-4">Ta funkcja zostanie dodana wkrótce! Zaloguj się, aby zapisywać swoje wyniki.</p>
            <button onclick="showMainScreen()" class="menu-button bg-gray-500 text-white hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-300">
                Powrót
            </button>
        </div>
    </div>
    
    <!-- Pole do wyświetlania wiadomości (np. potwierdzenia logowania) -->
    <div id="message-box" class="message-box"></div>

    <!-- Firebase SDK - konfigurowany i ładowany dynamicznie przez system -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, FacebookAuthProvider, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Funkcja do wyświetlania tymczasowych wiadomości
        function showMessage(message, type = 'success') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            if (type === 'error') {
                messageBox.style.backgroundColor = '#ef4444'; // Czerwony dla błędów
            } else {
                messageBox.style.backgroundColor = '#4CAF50'; // Zielony dla sukcesów
            }
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // --- Inicjalizacja Firebase ---
        let db;
        let auth;
        let currentUser;
        let isAuthReady = false; // Nowy wskaźnik gotowości

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        async function initFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.error("Błąd krytyczny: Brak obiektu konfiguracyjnego Firebase lub klucza API.");
                showMessage("Wystąpił błąd podczas ładowania aplikacji. Brak konfiguracji Firebase.", "error");
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }

                // Nasłuchuj zmian stanu uwierzytelnienia. Uruchamia się raz, gdy stan jest znany.
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true; // Potwierdź, że Firebase Auth jest gotowe
                    console.log("Firebase Auth jest gotowy. Użytkownik:", user ? user.uid : "Brak");
                    
                    if (user) {
                        currentUser = user;
                        document.getElementById('user-info').textContent = `Witaj, ${user.displayName || 'Gościu'}!`;
                        document.getElementById('auth-buttons').classList.add('hidden');
                        document.getElementById('logout-button').classList.remove('hidden');
                        console.log("Użytkownik zalogowany:", user.uid, user.displayName);
                        loadReminders();
                    } else {
                        currentUser = null;
                        document.getElementById('user-info').textContent = 'Zaloguj się, aby zapisywać postępy.';
                        document.getElementById('auth-buttons').classList.remove('hidden');
                        document.getElementById('logout-button').classList.add('hidden');
                        document.getElementById('reminders-list').innerHTML = '';
                        console.log("Użytkownik wylogowany.");
                    }
                });
            } catch (error) {
                console.error("Błąd inicjalizacji Firebase:", error);
                showMessage(`Wystąpił błąd podczas ładowania aplikacji. Błąd: ${error.message}`, "error");
            }
        }
        
        window.onload = initFirebase;

        // --- Funkcje logowania ---
        // Wszystkie funkcje operujące na Firebase mają teraz dodatkowe sprawdzenie isAuthReady
        function checkAuthAndRun(callback) {
            if (!isAuthReady || !auth) {
                showMessage("Błąd: Firebase Auth nie jest jeszcze zainicjowany. Proszę czekać.", "error");
                console.error("Próba użycia Firebase Auth przed inicjalizacją.");
                return;
            }
            callback();
        }

        window.signInWithGoogle = () => checkAuthAndRun(async () => {
            if (!isAuthReady) return;
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                showMessage("Pomyślnie zalogowano z Google!");
            } catch (error) {
                console.error("Błąd logowania z Google:", error.code, error.message, error);
                showMessage(`Błąd logowania: ${error.message}. Spróbuj ponownie.`, "error");
            }
        });

        window.signInWithFacebook = () => checkAuthAndRun(async () => {
            if (!isAuthReady) return;
            try {
                const provider = new FacebookAuthProvider();
                await signInWithPopup(auth, provider);
                showMessage("Pomyślnie zalogowano z Facebook!");
            } catch (error) {
                console.error("Błąd logowania z Facebook:", error.code, error.message, error);
                showMessage(`Błąd logowania: ${error.message}. Spróbuj ponownie.`, "error");
            }
        });

        window.signOutUser = () => checkAuthAndRun(async () => {
            if (!isAuthReady) return;
            try {
                await signOut(auth);
                showMessage("Pomyślnie wylogowano.");
            } catch (error) {
                console.error("Błąd wylogowania:", error);
                showMessage("Błąd wylogowania. Spróbuj ponownie.", "error");
            }
        });
        
        // --- Funkcje nawigacji ---
        window.showMainScreen = () => {
            document.getElementById('main-screen').classList.remove('hidden');
            document.getElementById('reminders-screen').classList.add('hidden');
            document.getElementById('games-screen').classList.add('hidden');
            document.getElementById('ranking-screen').classList.add('hidden');
        };

        window.showReminders = () => {
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('reminders-screen').classList.remove('hidden');
            document.getElementById('games-screen').classList.add('hidden');
            document.getElementById('ranking-screen').classList.add('hidden');
        };

        window.showGames = () => {
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('reminders-screen').classList.add('hidden');
            document.getElementById('games-screen').classList.remove('hidden');
            document.getElementById('ranking-screen').classList.add('hidden');
        };

        window.showRanking = () => {
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('reminders-screen').classList.add('hidden');
            document.getElementById('games-screen').classList.add('hidden');
            document.getElementById('ranking-screen').classList.remove('hidden');
        };

        // --- Funkcje zegara i daty ---
        function updateTime() {
            const now = new Date();
            const time = now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
            const date = now.toLocaleDateString('pl-PL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('time-display').textContent = time;
            document.getElementById('date-display').textContent = date;
        }
        setInterval(updateTime, 1000);
        updateTime();

        // --- Funkcje przypomnień ---
        window.addReminder = () => checkAuthAndRun(async () => {
            if (!currentUser || !db) {
                showMessage("Zaloguj się, aby dodawać przypomnienia.", "error");
                console.log("Brak użytkownika lub bazy danych, nie można dodać przypomnienia.");
                return;
            }
            const input = document.getElementById('new-reminder-input');
            const text = input.value.trim();
            if (text === "") {
                console.log("Puste przypomnienie, nie dodano.");
                return;
            }

            try {
                const userId = currentUser.uid;
                const remindersCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'reminders');
                await setDoc(doc(remindersCollectionRef), {
                    text: text,
                    createdAt: new Date()
                });
                input.value = '';
                showMessage("Przypomnienie dodane!");
                console.log("Dodano przypomnienie:", text);
            } catch (error) {
                console.error("Błąd dodawania przypomnienia:", error);
                showMessage("Błąd podczas dodawania przypomnienia. Sprawdź uprawnienia w Firestore.", "error");
            }
        });

        window.deleteReminder = (docId) => checkAuthAndRun(async () => {
            if (!currentUser || !db) {
                showMessage("Zaloguj się, aby usuwać przypomnienia.", "error");
                console.log("Brak użytkownika lub bazy danych, nie można usunąć przypomnienia.");
                return;
            }
            try {
                const userId = currentUser.uid;
                const reminderDocRef = doc(db, 'artifacts', appId, 'users', userId, 'reminders', docId);
                await deleteDoc(reminderDocRef);
                showMessage("Przypomnienie usunięte!");
                console.log("Usunięto przypomnienie o id:", docId);
            } catch (error) {
                console.error("Błąd usuwania przypomnienia:", error);
                showMessage("Błąd podczas usuwania przypomnienia.", "error");
            }
        });

        // Funkcja do ładowania przypomnień
        function loadReminders() {
            if (!currentUser || !db) {
                console.log("loadReminders(): Brak zalogowanego użytkownika lub bazy danych. Nie można załadować przypomnień.");
                return;
            }
            const userId = currentUser.uid;
            const remindersList = document.getElementById('reminders-list');
            const remindersCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'reminders');

            // Użyj onSnapshot, aby na bieżąco aktualizować listę
            onSnapshot(remindersCollectionRef, (querySnapshot) => {
                remindersList.innerHTML = '';
                if (querySnapshot.empty) {
                    console.log("Brak przypomnień do wyświetlenia.");
                    remindersList.innerHTML = '<p class="text-center text-gray-500">Brak przypomnień. Dodaj pierwsze!</p>';
                }
                querySnapshot.forEach((doc) => {
                    const reminderData = doc.data();
                    const reminderItem = document.createElement('div');
                    reminderItem.className = 'reminder-item';
                    reminderItem.innerHTML = `
                        <span>${reminderData.text}</span>
                        <button class="delete-btn" onclick="deleteReminder('${doc.id}')">Usuń</button>
                    `;
                    remindersList.appendChild(reminderItem);
                });
                console.log("Przypomnienia załadowane pomyślnie.");
            }, (error) => {
                console.error("Błąd ładowania przypomnień:", error);
                showMessage("Błąd podczas ładowania przypomnień. Sprawdź uprawnienia w Firestore.", "error");
            });
        }
        
    </script>
</body>
</html>

